name: Validate Poetry dependencies in Nixpkgs

on:
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'poetry.lock'

jobs:
  check-python-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 2  # So we can diff with base

      - name: Install Nix
        uses: cachix/install-nix-action@17fe5fb4a23ad6cbbe47d6b3f359611ad276644c # v31

      - name: Get base branch pyproject.toml
        run: |
          git show origin/${{ github.base_ref }}:pyproject.toml > pyproject.base.toml

      - name: Check changed dependencies against Nixpkgs
        run: |
          pip install toml packaging
          python .github/scripts/check_nixpkgs_versions.py pyproject.base.toml pyproject.toml
